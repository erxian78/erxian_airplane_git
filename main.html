<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="main.css" type="text/css" />
    <title>main_page</title>
</head>
<body>
<div class="nav">
    <div>
        <p id="welcome">Please sign in!</p>
        <a href="add_user.html">Logout</a>
    </div>
</div>
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript">
    $(function(){
        $.get("seat.php", function (data) {
            let allResults = JSON.parse(data);
            let seatResults = JSON.parse(allResults.results);
            let user_id = JSON.parse(allResults.user_id);
            let m = 11;
            let n = 7;
            let seatString = "<table border=\"0\"><tr><td width=\"50px\" align=\"center\"></td>";
            for(let i = 0;i < n - 1;i ++)
            {
                seatString += "<td width=\"50px\" align=\"center\">";
                let column = String.fromCharCode(65+i);
                seatString += column;
                seatString += "</td>";
            }
            for(let i = 1;i < m;i ++)
            {
                seatString += "<tr align=\"center\">";
                seatString += "<td width=\"50px\">" + i + "</td>";
                for(let j = 1;j < n;j ++){
                    let color;
                    let cursor = "pointer";
                    let currentIndex = (i - 1) * 6 + j - 1;
                    switch (seatResults[currentIndex]) {
                        case "free":
                            color = "#66bb6a";
                            break;
                        case "purchase":
                            color = "#ef5350";
                            cursor = "not-allowed";
                            break;
                        case "reserved":
                            color = "#ffee58";
                            break;
                    }
                    //座位已经被别人reserved
                    if(allResults.currentUserId != user_id[currentIndex] && user_id[currentIndex] > 0 && seatResults[currentIndex] != "purchase") {
                        color = "#ffa726";
                        //cursor = "not-allowed";
                    }
                    if(seatResults[currentIndex]){
                        seatString += "<td width=\"50px\" height=\"30px\" style='cursor: " + cursor + "' bgcolor=" + color + " class='seat' id=" + i + "-" + j +"-"+allResults.currentUserId+ " onclick='reserveSeat(this)'></td>";
                    }
                }
                seatString += "</tr>";
            }
            seatString += "</table>";
            $("body").append(seatString);
            let infoString = "<div class='info'><p>The total number of seats:&nbsp;<span>" + seatResults.length  + "</span></p>";
            infoString += "<p>The total number of purchased:&nbsp;<span>" + allResults.purchase + "</span></p>";
            infoString += "<p>The total number of reserved:&nbsp;<span>" + allResults.reserved + "</span></p>";
            infoString += "<p>The total number of free:&nbsp;<span>" + allResults.free + "</span></p></div>";
            $("body").append(infoString);
            if(allResults.currentUser) {
                //从起始位置到终止位置的内容, 但它去除Html标签
                $("#welcome")[0].innerText = "Welcome\n " + allResults.currentUser;
                //$("#log_in")[0].innerText = "Log out" ;
            }
        });
    });

    reserveSeat = (self) => {
        let row = self.id.split('-')[0];
        let column = self.id.split('-')[1];
        let user_id=self.id.split('-')[2];
        let bgColor = $(`#${self.id}`)[0].bgColor;
        if (bgColor === '#ef5350' ){
            return;
        }
        $.ajax({
            url: "update-seat.php",
            type: 'POST',
            data: { row: row, column: column, user_id: user_id , status: "reserved" },
            success: function (data) {
                if(data === 'error'){
                    confirm("Sorry, this seat has been purchased or reserved by others");
                } else if (data === 'success') {
                    const reserveCount = parseInt($('.info > p > span')[2].innerText);
                    if(bgColor == '#ffee58') {
                        $(`#${self.id}`)[0].bgColor = '#66bb6a';
                        $('.info > p > span')[2].innerText = reserveCount - 1;
                    }
                    else{
                        $(`#${self.id}`)[0].bgColor = '#ffee58';
                        $('.info > p > span')[2].innerText = reserveCount + 1;
                    }
                }
            },
            error: function (error) {
                confirm("Sorry, system has occured some error");
            }
        });
    }

    buySeat = () => {
        $.ajax({
            url:"buy-seat.php",
            type: 'POST',
            data: { user_id: 20,  reserved_num:1 },
            success: function (data) {
                if(data === 'error'){
                    confirm("Sorry, your buying request has been rejected");
                } else if (data === 'success') {
                    confirm("buying success!");
                   window.location.href='main.html';
                }
            },
            error: function (error) {
                confirm("Sorry, system has occured some error");
            }

        });
    }
</script>
<div class="operations">
    <div style="text-align: left;">
        <p><span class="color-info" style="background: #66bb6a;"></span><span>free</span></p>
        <p><span class="color-info" style="background: #ef5350;"></span>purchased</p>
        <p><span class="color-info" style="background: #ffee58;"></span>reserved</p>
        <p><span class="color-info" style="background: #ffa726;"></span>reserved by others</p>
    </div>
    <button onclick="buySeat()">Buy</button>
    <button onclick="window.location.href='main.html';">Update</button>
</div>
</body>
</html>