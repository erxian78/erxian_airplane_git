<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="main.css" type="text/css" />
    <title>main_page</title>
</head>
<body>
<div class="nav">
    <div>
        <p id="welcome">Please log in!</p>
        <a  href="add_user.html">Logout</a>
    </div>
</div>
<div class="buy-button">
    <button>Buy</button>
    <button>Update</button>
</div>
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript">
    $(function(){
        $.get("seat.php", function (data) {
            let allResults = JSON.parse(data);
            let seatResults = JSON.parse(allResults.results);
            let user_id=JSON.parse(allResults.user_id);
            let m = 11;
            let n = 7;
            let seatString = "<table border=\"0\"><tr><td width=\"50px\" align=\"center\"></td>";
            for(let i = 0;i < n - 1;i ++)
            {
                seatString += "<td width=\"50px\" align=\"center\">";
                let column = String.fromCharCode(65+i);
                seatString += column;
                seatString += "</td>";
            }
            for(let i = 1;i < m;i ++)
            {
                seatString += "<tr align=\"center\">";
                seatString += "<td width=\"50px\">" + i + "</td>";
                for(let j = 1;j < n;j ++){
                    let color;
                    switch (seatResults[(i - 1) * 6 + j - 1]) {
                        case "free":color="#adff2f";break;
                        case "purchased":color="#ff4500";break;
                        case "reserved":color="yellow";break;
                    }
                    //座位已经被别人reserved
                    if(allResults.currentUserId!=user_id[(i - 1) * 6 + j - 1]&&user_id[(i - 1) * 6 + j - 1]>0)
                    {
                        color="orange";
                    }
                    if(seatResults[(i - 1) * 6 + j - 1])
                    seatString += "<td width=\"50px\" bgcolor="+color+" class='seat' id=" + i + "-" + j + " onclick='reserveSeat(this)'>";
                    seatString += seatResults[(i - 1) * 6 + j - 1];
                    seatString += "</td>";
                }
                seatString += "</tr>";
            }
            seatString += "</table>";
            $("body").append(seatString);
            let infoString = "<div class='info'><p>the total number of seats:&nbsp;" + seatResults.length + "</p>";
            infoString += "<p>the total number of purchased:&nbsp;" + allResults.purchase + "</p>";
            infoString += "<p>the total number of reserved:&nbsp;" + allResults.reserved + "</p>";
            infoString += "<p>the total number of free:&nbsp;" + allResults.free + "</p></div>";
            $("body").append(infoString);
            if(allResults.currentUser) {
                //从起始位置到终止位置的内容, 但它去除Html标签
                $("#welcome")[0].innerText = "Welcome\n " + allResults.currentUser;
                //$("#log_in")[0].innerText = "Log out" ;

            }
        });
    });

    reserveSeat = (self) => {
        let row = self.id.split('-')[0];
        let column = self.id.split('-')[1];
        $.ajax({
            url: "update-seat.php",
            type: 'PUT',
            data: { row: row, column: column, user_id: 1, status: "purchase" },
            success: function (data) {
                if(data === 'error'){
                    alert("Sorry, this seat has been purchased or reserved by others");
                } else if (data === 'success') {
                    confirm("You have reserve this seat successfully");
                    window.location.href="main.html";
                }
            },
            error: function (error) {
                confirm("Sorry, system has occured some error");
            }
        });
    }
</script>

</body>
</html>